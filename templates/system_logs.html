<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Logs - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .log-entry {
            border-left: 4px solid #007bff;
            margin-bottom: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .log-entry.login-failed {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }
        .log-entry.security {
            border-left-color: #ffc107;
            background-color: #fffbf0;
        }
        .log-entry.transaction {
            border-left-color: #28a745;
            background-color: #f0fff4;
        }
        .filter-badge {
            cursor: pointer;
            margin: 2px;
        }
        .filter-badge.active {
            background-color: #007bff !important;
        }
        .timestamp {
            font-size: 0.9em;
            color: #6c757d;
        }
        .activity-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        .icon-login { background-color: #e3f2fd; color: #1976d2; }
        .icon-failed { background-color: #ffebee; color: #d32f2f; }
        .icon-transaction { background-color: #e8f5e8; color: #388e3c; }
        .icon-security { background-color: #fff8e1; color: #f57c00; }
        .icon-default { background-color: #f5f5f5; color: #616161; }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('admin_dashboard') }}">
                <i class="fas fa-shield-alt"></i> Admin Panel
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text text-white me-3">System Logs</span>
                <a class="btn btn-outline-light btn-sm" href="{{ url_for('admin_dashboard') }}">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-file-alt"></i> System Activity Logs
                            </h5>
                            <div>
                                <span class="badge bg-light text-dark">{{ system_activities|length }} entries</span>
                                <button class="btn btn-light btn-sm ms-2" onclick="location.reload()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filter Section -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="d-flex flex-wrap align-items-center">
                                    <span class="me-3"><strong>Filter by type:</strong></span>
                                    <a href="{{ url_for('system_logs', type='all') }}" 
                                       class="badge bg-secondary filter-badge {{ 'active' if activity_type == 'all' else '' }}">
                                        All Activities
                                    </a>
                                    <a href="{{ url_for('system_logs', type='login') }}" 
                                       class="badge bg-primary filter-badge {{ 'active' if activity_type == 'login' else '' }}">
                                        Successful Logins
                                    </a>
                                    <a href="{{ url_for('system_logs', type='login_failed') }}" 
                                       class="badge bg-danger filter-badge {{ 'active' if activity_type == 'login_failed' else '' }}">
                                        Failed Logins
                                    </a>
                                    <a href="{{ url_for('system_logs', type='transaction') }}" 
                                       class="badge bg-success filter-badge {{ 'active' if activity_type == 'transaction' else '' }}">
                                        Transactions
                                    </a>
                                    <a href="{{ url_for('system_logs', type='profile_update') }}" 
                                       class="badge bg-warning filter-badge {{ 'active' if activity_type == 'profile_update' else '' }}">
                                        Profile Updates
                                    </a>
                                    <a href="{{ url_for('system_logs', type='notification_sent') }}" 
                                       class="badge bg-info filter-badge {{ 'active' if activity_type == 'notification_sent' else '' }}">
                                        Notifications
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Logs -->
                        <div class="activity-logs">
                            {% if system_activities %}
                                {% for activity in system_activities %}
                                <div class="log-entry 
                                    {% if activity.activity_type == 'login_failed' %}login-failed{% endif %}
                                    {% if activity.activity_type in ['security_alert', 'suspicious_activity'] %}security{% endif %}
                                    {% if 'transaction' in activity.activity_type %}transaction{% endif %}">
                                    
                                    <div class="d-flex align-items-start">
                                        <!-- Activity Icon -->
                                        <div class="activity-icon 
                                            {% if activity.activity_type == 'login' %}icon-login{% endif %}
                                            {% if activity.activity_type == 'login_failed' %}icon-failed{% endif %}
                                            {% if 'transaction' in activity.activity_type %}icon-transaction{% endif %}
                                            {% if activity.activity_type in ['security_alert', 'suspicious_activity'] %}icon-security{% endif %}
                                            {% if activity.activity_type not in ['login', 'login_failed', 'transaction', 'security_alert', 'suspicious_activity'] %}icon-default{% endif %}">
                                            {% if activity.activity_type == 'login' %}
                                                <i class="fas fa-sign-in-alt"></i>
                                            {% elif activity.activity_type == 'login_failed' %}
                                                <i class="fas fa-exclamation-triangle"></i>
                                            {% elif 'transaction' in activity.activity_type %}
                                                <i class="fas fa-exchange-alt"></i>
                                            {% elif activity.activity_type in ['security_alert', 'suspicious_activity'] %}
                                                <i class="fas fa-shield-alt"></i>
                                            {% else %}
                                                <i class="fas fa-info-circle"></i>
                                            {% endif %}
                                        </div>

                                        <!-- Activity Details -->
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong>{{ activity.activity_type|replace('_', ' ')|title }}</strong>
                                                    {% if activity.account_number %}
                                                        <span class="text-muted">- Account: {{ activity.account_number }}</span>
                                                    {% endif %}
                                                </div>
                                                <div class="timestamp">
                                                    <i class="far fa-clock"></i> {{ activity.timestamp.strftime('%d %b %Y, %H:%M:%S') }}
                                                </div>
                                            </div>
                                            
                                            {% if activity.ip_address or activity.details %}
                                            <div class="mt-2">
                                                {% if activity.ip_address %}
                                                    <small class="text-muted me-3">
                                                        <i class="fas fa-map-marker-alt"></i> IP: {{ activity.ip_address }}
                                                    </small>
                                                {% endif %}
                                                {% if activity.details %}
                                                    <small class="text-muted">
                                                        <i class="fas fa-info-circle"></i> 
                                                        {% if activity.details is mapping %}
                                                            {% for key, value in activity.details.items() %}
                                                                {{ key|replace('_', ' ')|title }}: {{ value }}{% if not loop.last %}, {% endif %}
                                                            {% endfor %}
                                                        {% elif activity.details is iterable and activity.details is not string %}
                                                            {% for item in activity.details %}
                                                                {{ item }}{% if not loop.last %}, {% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            {{ activity.details }}
                                                        {% endif %}
                                                    </small>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No activities found</h5>
                                    <p class="text-muted">No system activities match the selected filter.</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Summary Stats -->
                        <div class="row mt-4">
                            <div class="col-md-3 text-center">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="text-primary">{{ system_activities|selectattr('activity_type', 'equalto', 'login')|list|length }}</h5>
                                        <small class="text-muted">Successful Logins</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="text-danger">{{ system_activities|selectattr('activity_type', 'equalto', 'login_failed')|list|length }}</h5>
                                        <small class="text-muted">Failed Logins</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="text-success">{{ system_activities|selectattr('activity_type', 'equalto', 'transaction')|list|length }}</h5>
                                        <small class="text-muted">Transactions</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="text-warning">{{ system_activities|selectattr('activity_type', 'equalto', 'security_alert')|list|length }}</h5>
                                        <small class="text-muted">Security Alerts</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Auto-refresh every 60 seconds
        setTimeout(function() {
            location.reload();
        }, 60000);

        // Add some interactivity
        document.querySelectorAll('.filter-badge').forEach(badge => {
            badge.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = this.href;
            });
        });
    </script>
</body>
</html>