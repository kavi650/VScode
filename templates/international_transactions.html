{% extends "base.html" %}

{% block title %}International Transactions - E-Bank{% endblock %}

{% block content %}
<div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1 class="page-title" style="margin-bottom: 0;">
            <i class="fas fa-globe"></i> International Transactions
        </h1>
        <a href="{{ url_for('enhanced_customer_dashboard') }}" class="btn btn-blue btn-right">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Account Balance Display -->
    <div class="balance-overview">
        <div class="balance-card">
            <h3><i class="fas fa-university"></i> Your Account Balance</h3>
            <div class="amount">â‚¹{{ "%.2f"|format(user.account_balance) }}</div>
            <p>Available for international transfers</p>
        </div>
    </div>

    <!-- Currency Converter -->
    <div class="converter-section">
        <h3><i class="fas fa-exchange-alt"></i> Currency Converter</h3>
        <div class="converter-form">
            <div class="converter-input">
                <label>From</label>
                <div class="input-group">
                    <input type="number" id="from_amount" placeholder="0.00" min="0" step="0.01">
                    <select id="from_currency">
                        {% for code, name in currencies.items() %}
                        <option value="{{ code }}" {% if code == 'INR' %}selected{% endif %}>{{ code }} - {{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="converter-swap">
                <button type="button" onclick="swapCurrencies()" class="swap-btn">
                    <i class="fas fa-exchange-alt"></i>
                </button>
            </div>
            
            <div class="converter-input">
                <label>To</label>
                <div class="input-group">
                    <input type="number" id="to_amount" placeholder="0.00" readonly>
                    <select id="to_currency">
                        {% for code, name in currencies.items() %}
                        <option value="{{ code }}" {% if code == 'USD' %}selected{% endif %}>{{ code }} - {{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <div class="exchange-rate-display" id="rate-display" style="display: none;">
            <div class="rate-info">
                <span class="rate-text" id="rate-text"></span>
                <span class="rate-time" id="rate-time"></span>
            </div>
        </div>
        
        <button type="button" onclick="convertCurrency()" class="btn converter-btn">
            <i class="fas fa-calculator"></i> Convert
        </button>
    </div>

    <!-- International Transfer -->
    <div class="transfer-section">
        <h3><i class="fas fa-paper-plane"></i> Send International Transfer</h3>
        <form id="transferForm" class="transfer-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="recipient_account">Recipient Account Number</label>
                    <input type="text" id="recipient_account" name="recipient_account" class="form-control" 
                           pattern="[0-9]{8}" placeholder="Enter 8-digit account number" required>
                </div>
                
                <div class="form-group">
                    <label for="transfer_amount">Amount</label>
                    <input type="number" id="transfer_amount" name="amount" class="form-control" 
                           min="0.01" step="0.01" placeholder="Enter amount" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="from_currency_transfer">Send In</label>
                    <select id="from_currency_transfer" name="from_currency" class="form-control">
                        {% for code, name in currencies.items() %}
                        <option value="{{ code }}" {% if code == 'INR' %}selected{% endif %}>{{ code }} - {{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="to_currency_transfer">Recipient Receives</label>
                    <select id="to_currency_transfer" name="to_currency" class="form-control">
                        {% for code, name in currencies.items() %}
                        <option value="{{ code }}" {% if code == 'USD' %}selected{% endif %}>{{ code }} - {{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="transfer-preview" id="transfer-preview" style="display: none;">
                <div class="preview-card">
                    <h4><i class="fas fa-info-circle"></i> Transfer Preview</h4>
                    <div class="preview-details">
                        <div class="preview-row">
                            <span>You send:</span>
                            <span id="preview-send"></span>
                        </div>
                        <div class="preview-row">
                            <span>Exchange rate:</span>
                            <span id="preview-rate"></span>
                        </div>
                        <div class="preview-row">
                            <span>Recipient gets:</span>
                            <span id="preview-receive"></span>
                        </div>
                        <div class="preview-row total">
                            <span>Total from your account:</span>
                            <span id="preview-total"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="transfer_pin">Enter PIN to Confirm</label>
                <input type="password" id="transfer_pin" name="pin" class="form-control pin-input" 
                       pattern="[0-9]{4}" maxlength="4" placeholder="Enter 4-digit PIN">
            </div>
            
            <button type="submit" class="btn transfer-btn">
                <i class="fas fa-globe"></i> Send International Transfer
            </button>
        </form>
    </div>

    <!-- Live Exchange Rates -->
    <div class="rates-section">
        <h3><i class="fas fa-chart-line"></i> Live Exchange Rates</h3>
        <div class="rates-grid" id="rates-grid">
            <div class="loading-rates">
                <i class="fas fa-spinner fa-spin"></i> Loading live rates...
            </div>
        </div>
        <p class="rates-disclaimer">
            <i class="fas fa-info-circle"></i> Rates are updated in real-time and may fluctuate. 
            Actual transaction rates are locked at the time of transfer.
        </p>
    </div>
</div>

<style>
.balance-overview {
    margin-bottom: 2rem;
}

.balance-card {
    background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
    color: white;
    padding: 2rem;
    border-radius: 15px;
    text-align: center;
    box-shadow: var(--shadow-hover);
}

.balance-card .amount {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 1rem 0;
}

.converter-section, .transfer-section, .rates-section {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
}

.converter-section h3, .transfer-section h3, .rates-section h3 {
    color: var(--primary-dark);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.converter-form {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 2rem;
    align-items: end;
    margin-bottom: 2rem;
}

.converter-input label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--primary-dark);
}

.input-group {
    display: flex;
    gap: 0.5rem;
}

.input-group input {
    flex: 1;
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1.1rem;
}

.input-group select {
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    min-width: 120px;
}

.converter-swap {
    display: flex;
    align-items: center;
    justify-content: center;
}

.swap-btn {
    background: var(--primary-light);
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}

.swap-btn:hover {
    background: var(--primary-dark);
    transform: rotate(180deg);
}

.exchange-rate-display {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border-left: 4px solid var(--primary-light);
}

.rate-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.rate-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary-dark);
}

.rate-time {
    font-size: 0.9rem;
    color: #666;
}

.converter-btn, .transfer-btn {
    width: 100%;
    padding: 1rem;
    font-size: 1.1rem;
    font-weight: 600;
}

.transfer-form {
    max-width: 600px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.transfer-preview {
    margin: 2rem 0;
}

.preview-card {
    background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
    border-radius: 12px;
    padding: 1.5rem;
    border: 2px solid var(--primary-light);
}

.preview-card h4 {
    color: var(--primary-dark);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.preview-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.preview-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.preview-row.total {
    border-top: 2px solid var(--primary-light);
    padding-top: 0.75rem;
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--primary-dark);
}

.pin-input {
    max-width: 200px;
    text-align: center;
    font-size: 1.2rem;
    font-weight: 600;
    letter-spacing: 0.5rem;
}

.rates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.rate-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.rate-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.rate-card .currency-pair {
    font-weight: bold;
    color: var(--primary-dark);
    margin-bottom: 0.5rem;
}

.rate-card .rate-value {
    font-size: 1.5rem;
    color: var(--primary-light);
    font-weight: bold;
}

.rate-card .rate-change {
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

.rate-change.positive {
    color: var(--success);
}

.rate-change.negative {
    color: var(--danger);
}

.loading-rates {
    grid-column: 1 / -1;
    text-align: center;
    color: #666;
    padding: 2rem;
    font-size: 1.1rem;
}

.rates-disclaimer {
    font-size: 0.9rem;
    color: #666;
    text-align: center;
    margin-top: 1rem;
}

@media (max-width: 768px) {
    .converter-form {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .converter-swap {
        order: 3;
    }
    
    .swap-btn {
        transform: rotate(90deg);
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .rates-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
}
</style>

<script>
let exchangeRates = {};

// Load live exchange rates on page load
document.addEventListener('DOMContentLoaded', function() {
    loadLiveRates();
    
    // Set up auto-conversion
    document.getElementById('from_amount').addEventListener('input', convertCurrency);
    document.getElementById('from_currency').addEventListener('change', convertCurrency);
    document.getElementById('to_currency').addEventListener('change', convertCurrency);
    
    // Set up transfer preview
    document.getElementById('transfer_amount').addEventListener('input', updateTransferPreview);
    document.getElementById('from_currency_transfer').addEventListener('change', updateTransferPreview);
    document.getElementById('to_currency_transfer').addEventListener('change', updateTransferPreview);
    
    // PIN input validation
    document.getElementById('transfer_pin').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
    });
});

async function loadLiveRates() {
    const baseCurrencies = ['INR', 'USD', 'EUR', 'GBP'];
    const targetCurrencies = ['USD', 'EUR', 'GBP', 'JPY', 'AUD', 'CAD'];
    const ratesGrid = document.getElementById('rates-grid');
    
    try {
        ratesGrid.innerHTML = '<div class="loading-rates"><i class="fas fa-spinner fa-spin"></i> Loading live rates...</div>';
        
        let rateCards = '';
        
        for (const base of baseCurrencies) {
            for (const target of targetCurrencies) {
                if (base !== target) {
                    try {
                        const response = await fetch(`/get_exchange_rate/${base}/${target}`);
                        const data = await response.json();
                        
                        if (data.rate) {
                            exchangeRates[`${base}_${target}`] = data.rate;
                            
                            // Generate random change for demo (in real app, this would come from API)
                            const change = (Math.random() - 0.5) * 0.02;
                            const changeClass = change >= 0 ? 'positive' : 'negative';
                            const changeSymbol = change >= 0 ? 'â†—' : 'â†˜';
                            
                            rateCards += `
                                <div class="rate-card">
                                    <div class="currency-pair">${base}/${target}</div>
                                    <div class="rate-value">${data.rate.toFixed(4)}</div>
                                    <div class="rate-change ${changeClass}">
                                        ${changeSymbol} ${Math.abs(change * 100).toFixed(2)}%
                                    </div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error(`Failed to load rate for ${base}/${target}:`, error);
                    }
                }
            }
        }
        
        ratesGrid.innerHTML = rateCards || '<div class="loading-rates">Unable to load exchange rates</div>';
        
    } catch (error) {
        console.error('Failed to load exchange rates:', error);
        ratesGrid.innerHTML = '<div class="loading-rates">Unable to load exchange rates</div>';
    }
}

async function convertCurrency() {
    const fromAmount = parseFloat(document.getElementById('from_amount').value);
    const fromCurrency = document.getElementById('from_currency').value;
    const toCurrency = document.getElementById('to_currency').value;
    
    if (!fromAmount || fromAmount <= 0) {
        document.getElementById('to_amount').value = '';
        document.getElementById('rate-display').style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch(`/get_exchange_rate/${fromCurrency}/${toCurrency}`);
        const data = await response.json();
        
        if (data.rate) {
            const convertedAmount = fromAmount * data.rate;
            document.getElementById('to_amount').value = convertedAmount.toFixed(2);
            
            // Show rate display
            document.getElementById('rate-text').textContent = 
                `1 ${fromCurrency} = ${data.rate.toFixed(4)} ${toCurrency}`;
            document.getElementById('rate-time').textContent = 
                `Updated: ${new Date().toLocaleTimeString()}`;
            document.getElementById('rate-display').style.display = 'block';
        }
    } catch (error) {
        console.error('Conversion failed:', error);
        document.getElementById('to_amount').value = 'Error';
    }
}

function swapCurrencies() {
    const fromCurrency = document.getElementById('from_currency');
    const toCurrency = document.getElementById('to_currency');
    const fromAmount = document.getElementById('from_amount');
    const toAmount = document.getElementById('to_amount');
    
    // Swap currencies
    const tempCurrency = fromCurrency.value;
    fromCurrency.value = toCurrency.value;
    toCurrency.value = tempCurrency;
    
    // Swap amounts
    const tempAmount = fromAmount.value;
    fromAmount.value = toAmount.value;
    toAmount.value = tempAmount;
    
    // Trigger conversion
    convertCurrency();
}

async function updateTransferPreview() {
    const amount = parseFloat(document.getElementById('transfer_amount').value);
    const fromCurrency = document.getElementById('from_currency_transfer').value;
    const toCurrency = document.getElementById('to_currency_transfer').value;
    
    if (!amount || amount <= 0) {
        document.getElementById('transfer-preview').style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch(`/get_exchange_rate/${fromCurrency}/${toCurrency}`);
        const data = await response.json();
        
        if (data.rate) {
            const convertedAmount = amount * data.rate;
            
            // Calculate INR equivalent if sending in foreign currency
            let inrEquivalent = amount;
            if (fromCurrency !== 'INR') {
                const inrResponse = await fetch(`/get_exchange_rate/${fromCurrency}/INR`);
                const inrData = await inrResponse.json();
                inrEquivalent = amount * inrData.rate;
            }
            
            // Update preview
            document.getElementById('preview-send').textContent = 
                `${amount.toFixed(2)} ${fromCurrency}`;
            document.getElementById('preview-rate').textContent = 
                `1 ${fromCurrency} = ${data.rate.toFixed(4)} ${toCurrency}`;
            document.getElementById('preview-receive').textContent = 
                `${convertedAmount.toFixed(2)} ${toCurrency}`;
            document.getElementById('preview-total').textContent = 
                `â‚¹${inrEquivalent.toFixed(2)} INR`;
            
            document.getElementById('transfer-preview').style.display = 'block';
        }
    } catch (error) {
        console.error('Preview update failed:', error);
    }
}

// Handle transfer form submission
document.getElementById('transferForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    try {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Transfer...';
        submitBtn.disabled = true;
        
        const response = await fetch('/international_transfer', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success message
            showNotification(result.message, 'success');
            
            // Reset form
            this.reset();
            document.getElementById('transfer-preview').style.display = 'none';
            
            // Refresh page after delay to show updated balance
            setTimeout(() => {
                window.location.reload();
            }, 3000);
            
        } else {
            showNotification(result.error, 'error');
        }
        
    } catch (error) {
        console.error('Transfer failed:', error);
        showNotification('Transfer failed. Please try again.', 'error');
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    
    const icon = type === 'success' ? 'check-circle' : 
                 type === 'error' ? 'exclamation-circle' : 
                 'info-circle';
    
    notification.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">&times;</button>
    `;
    
    // Add notification styles if not already added
    if (!document.querySelector('#notification-styles')) {
        const notificationStyles = document.createElement('style');
        notificationStyles.id = 'notification-styles';
        notificationStyles.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                color: var(--text-dark);
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                z-index: 1001;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                animation: slideInRight 0.3s ease-out;
                max-width: 300px;
                border-left: 4px solid var(--primary-light);
            }
            
            .notification-success {
                border-left-color: var(--success);
            }
            
            .notification-error {
                border-left-color: var(--danger);
            }
            
            .notification button {
                background: none;
                border: none;
                font-size: 1.2rem;
                cursor: pointer;
                margin-left: auto;
                opacity: 0.6;
                transition: opacity 0.3s ease;
            }
            
            .notification button:hover {
                opacity: 1;
            }
            
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(notificationStyles);
    }
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Refresh rates every 30 seconds
setInterval(loadLiveRates, 30000);
</script>
{% endblock %}