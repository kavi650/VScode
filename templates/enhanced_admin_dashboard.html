{% extends "base.html" %}

{% block title %}Admin Dashboard - E-Bank{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="admin-header">
        <h1 class="page-title">
            <i class="fas fa-tachometer-alt"></i> Admin Dashboard
        </h1>
        <div class="admin-info">
            <span class="admin-badge">
                <i class="fas fa-shield-alt"></i> Administrator
            </span>
        </div>
    </div>

    <!-- Enhanced Statistics Cards -->
    <div class="stats-grid-enhanced">
        <div class="stat-card total-customers">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-trend">
                    <span class="trend-indicator positive">
                        <i class="fas fa-arrow-up"></i> 12%
                    </span>
                </div>
            </div>
            <div class="stat-content">
                <h4>Total Customers</h4>
                <div class="stat-value">{{ total_customers }}</div>
                <div class="stat-subtitle">Active: {{ active_customers }}</div>
            </div>
        </div>
        
        <div class="stat-card bank-balance">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-university"></i>
                </div>
                <div class="stat-trend">
                    <span class="trend-indicator positive">
                        <i class="fas fa-arrow-up"></i> 8%
                    </span>
                </div>
            </div>
            <div class="stat-content">
                <h4>Total Bank Balance</h4>
                <div class="stat-value">₹{{ "%.2f"|format(total_bank_balance) }}</div>
                <div class="stat-subtitle">All accounts combined</div>
            </div>
        </div>
        
        <div class="stat-card wallet-balance">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="stat-trend">
                    <span class="trend-indicator positive">
                        <i class="fas fa-arrow-up"></i> 15%
                    </span>
                </div>
            </div>
            <div class="stat-content">
                <h4>Total Wallet Balance</h4>
                <div class="stat-value">₹{{ "%.2f"|format(total_wallet_balance) }}</div>
                <div class="stat-subtitle">Ready for payments</div>
            </div>
        </div>
        
        <div class="stat-card system-status">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-server"></i>
                </div>
                <div class="stat-trend">
                    <span class="trend-indicator neutral">
                        <i class="fas fa-check-circle"></i> Online
                    </span>
                </div>
            </div>
            <div class="stat-content">
                <h4>System Status</h4>
                <div class="stat-value">96.9%</div>
                <div class="stat-subtitle">Uptime this month</div>
            </div>
        </div>
    </div>

    <!-- Enhanced Navigation Menu (New Layout) -->
    <div class="admin-nav-enhanced">
        <a href="{{ url_for('enhanced_create_account') }}" class="admin-nav-btn create">
            <div class="nav-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="nav-content">
                <h3>Create Account</h3>
                <p>Add new customer accounts</p>
            </div>
            <div class="nav-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>
        
        <a href="{{ url_for('enhanced_users_management') }}" class="admin-nav-btn users">
            <div class="nav-icon">
                <i class="fas fa-users-cog"></i>
            </div>
            <div class="nav-content">
                <h3>Users Management</h3>
                <p>Manage customer accounts & activities</p>
            </div>
            <div class="nav-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>
        
        <a href="{{ url_for('analytics') }}" class="admin-nav-btn analytics">
            <div class="nav-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="nav-content">
                <h3>Enhanced Analytics</h3>
                <p>Transaction insights & trends</p>
            </div>
            <div class="nav-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>
        
        <a href="{{ url_for('transaction_reports') }}" class="admin-nav-btn reports">
            <div class="nav-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="nav-content">
                <h3>Transaction Reports</h3>
                <p>Generate detailed reports</p>
            </div>
            <div class="nav-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>
        
        <a href="{{ url_for('search_profiles') }}" class="admin-nav-btn search">
            <div class="nav-icon">
                <i class="fas fa-search"></i>
            </div>
            <div class="nav-content">
                <h3>Search Profiles</h3>
                <p>Find customer information</p>
            </div>
            <div class="nav-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>
        
        <a href="{{ url_for('multi_currency_dashboard') }}" class="admin-nav-btn currency">
            <div class="nav-icon">
                <i class="fas fa-globe-americas"></i>
            </div>
            <div class="nav-content">
                <h3>Multi-Currency Dashboard</h3>
                <p>Exchange rates & international transactions</p>
            </div>
            <div class="nav-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>
    </div>

    <!-- Recent Activity Dashboard -->
    <div class="dashboard-sections">
        <div class="activity-section">
            <div class="section-header">
                <h3><i class="fas fa-activity"></i> Recent User Activity</h3>
                <div class="activity-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="login">Logins</button>
                    <button class="filter-btn" data-filter="transaction">Transactions</button>
                    <button class="filter-btn" data-filter="security">Security</button>
                </div>
            </div>
            
            <div class="activity-list">
                {% for activity in recent_activities %}
                <div class="activity-item" data-type="{{ activity.activity_type }}">
                    <div class="activity-icon">
                        {% if activity.activity_type == 'login' %}
                            <i class="fas fa-sign-in-alt" style="color: var(--success);"></i>
                        {% elif activity.activity_type == 'login_failed' %}
                            <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                        {% elif 'transaction' in activity.activity_type %}
                            <i class="fas fa-exchange-alt" style="color: var(--primary-light);"></i>
                        {% elif activity.activity_type == 'profile_update' %}
                            <i class="fas fa-user-edit" style="color: var(--warning);"></i>
                        {% else %}
                            <i class="fas fa-info-circle" style="color: var(--info);"></i>
                        {% endif %}
                    </div>
                    <div class="activity-details">
                        <div class="activity-title">
                            {{ activity.activity_type.replace('_', ' ').title() }}
                        </div>
                        <div class="activity-user">
                            Account: {{ activity.account_number }}
                        </div>
                        <div class="activity-meta">
                            <span class="activity-time">{{ activity.timestamp.strftime('%d %b, %H:%M') }}</span>
                            {% if activity.ip_address %}
                            <span class="activity-ip">{{ activity.ip_address }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="activity-status">
                        {% if 'failed' in activity.activity_type %}
                            <span class="status-badge failed">Failed</span>
                        {% else %}
                            <span class="status-badge success">Success</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- System Overview -->
        <div class="system-overview">
            <div class="section-header">
                <h3><i class="fas fa-server"></i> System Overview</h3>
                <button class="refresh-btn" onclick="refreshSystemStats()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            
            <div class="system-stats">
                <div class="system-stat">
                    <div class="stat-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Database</h4>
                        <p>{{ db_health.status }}</p>
                        <div class="stat-bar">
                            <div class="stat-fill" style="width: {{ db_health.capacity }}%"></div>
                        </div>
                        <small>{{ db_health.capacity }}% capacity ({{ db_health.user_count }} users, {{ db_health.transaction_count }} transactions)</small>
                    </div>
                </div>
                
                <div class="system-stat">
                    <div class="stat-icon">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Network</h4>
                        <p>{{ network_health.status }}</p>
                        <div class="stat-bar">
                            <div class="stat-fill" style="width: {{ network_health.uptime }}%"></div>
                        </div>
                        <small>{{ network_health.uptime }}% uptime ({{ network_health.response_time }}ms response)</small>
                    </div>
                </div>
                
                <div class="system-stat">
                    <div class="stat-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Security</h4>
                        <p>{{ security_status.status }}</p>
                        <div class="stat-bar">
                            <div class="stat-fill" style="width: {% if security_status.status == 'Protected' %}100{% elif security_status.status == 'Alert' %}50{% else %}75{% endif %}%"></div>
                        </div>
                        <small>{{ security_status.message }}</small>
                    </div>
                </div>
                
                <div class="system-stat">
                    <div class="stat-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Transactions</h4>
                        <p>{{ transaction_success_rate.status }}</p>
                        <div class="stat-bar">
                            <div class="stat-fill" style="width: {{ transaction_success_rate.rate }}%"></div>
                        </div>
                        <small>{{ transaction_success_rate.rate }}% success rate ({{ transaction_success_rate.successful }}/{{ transaction_success_rate.total }} transactions)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Admin Actions -->
    <div class="admin-actions">
        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
        <div class="actions-grid">
            <button class="action-card" onclick="viewSystemLogs()">
                <i class="fas fa-list-alt"></i>
                <span>View System Logs</span>
            </button>
            <button class="action-card" onclick="generateReport()">
                <i class="fas fa-chart-line"></i>
                <span>Generate Report</span>
            </button>
            <button class="action-card" onclick="backupDatabase()">
                <i class="fas fa-database"></i>
                <span>Backup Database</span>
            </button>
            <button class="action-card" onclick="systemMaintenance()">
                <i class="fas fa-tools"></i>
                <span>Maintenance Mode</span>
            </button>
            <button class="action-card" onclick="viewCurrencyRates()">
                <i class="fas fa-coins"></i>
                <span>Currency Rates</span>
            </button>
            <button class="action-card" onclick="notifyUsers()">
                <i class="fas fa-bell"></i>
                <span>Notify Users</span>
            </button>
        </div>
    </div>
</div>

<style>
body, html {
    height: 100%;
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: #f0f2f5;
    color: #333;
}
:root {
    --primary-dark: #0053ba;
    --primary-light: #00addb;
    --success: #28a745;
    --warning: #ffc107;
    --info: #17a2b8;
    --danger: #dc3545;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --shadow-hover: 0 8px 12px rgba(0, 0, 0, 0.15);
}

.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}
.page-title {
    font-size: 2rem;
    color: var(--primary-dark);
}
.admin-badge {
    background: linear-gradient(135deg, var(--success), #27ae60);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.stats-grid-enhanced {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}
.stat-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-light);
}
.stat-card.total-customers::before { background: linear-gradient(90deg, #3498db, #2980b9); }
.stat-card.bank-balance::before { background: linear-gradient(90deg, #27ae60, #229954); }
.stat-card.wallet-balance::before { background: linear-gradient(90deg, #f39c12, #e67e22); }
.stat-card.system-status::before { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}
.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}
.stat-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--primary-light), var(--primary-dark));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: white;
}
.trend-indicator {
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}
.trend-indicator.positive {
    background: #d4edda;
    color: #155724;
}
.trend-indicator.neutral {
    background: #e2e3e5;
    color: #383d41;
}
.stat-content h4 {
    margin: 0 0 0.5rem 0;
    color: #666;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-dark);
    margin-bottom: 0.5rem;
}
.stat-subtitle {
    color: #999;
    font-size: 0.8rem;
}

/* Updated Navigation Menu Styles to force 2 rows */
.admin-nav-enhanced {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
}

/* New media queries for responsive behavior on smaller screens */
@media (max-width: 992px) {
    .admin-nav-enhanced {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (max-width: 768px) {
    .admin-nav-enhanced {
        grid-template-columns: 1fr;
    }
}
.admin-nav-btn {
    background: linear-gradient(45deg, var(--primary-dark), var(--primary-light));
    border-radius: 15px;
    padding: 2rem;
    text-decoration: none;
    color: white;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 1.5rem;
}
.admin-nav-btn:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}
.nav-icon {
    width: 60px;
    height: 60px;
    background: transparent;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    flex-shrink: 0;
}
.nav-content {
    flex: 1;
}
.nav-content h3 {
    margin: 0 0 0.5rem 0;
    color: white;
    font-size: 1.2rem;
    font-weight: bold;
}
.nav-content p {
    margin: 0;
    color: white;
    font-size: 0.9rem;
}
.nav-arrow {
    color: white;
    font-size: 1.2rem;
    opacity: 0.7;
    transition: all 0.3s ease;
}
.admin-nav-btn:hover .nav-arrow {
    opacity: 1;
    transform: translateX(5px);
}
.dashboard-sections {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}
.activity-section, .system-overview {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: var(--shadow);
}
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}
.section-header h3 {
    margin: 0;
    color: var(--primary-dark);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.activity-filters {
    display: flex;
    gap: 0.5rem;
}
.filter-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #666;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}
.filter-btn.active, .filter-btn:hover {
    background: var(--primary-light);
    color: white;
    border-color: var(--primary-light);
}
.refresh-btn {
    background: var(--primary-light);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}
.refresh-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}
.activity-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.activity-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
    transition: all 0.3s ease;
}
.activity-item:hover {
    background: #e9ecef;
}
.activity-icon {
    width: 40px;
    height: 40px;
    background: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.activity-details {
    flex: 1;
}
.activity-title {
    font-weight: 600;
    color: var(--primary-dark);
    margin-bottom: 0.25rem;
}
.activity-user {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}
.activity-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    color: #999;
}
.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
}
.status-badge.success {
    background: #d4edda;
    color: #155724;
}
.status-badge.failed {
    background: #f8d7da;
    color: #721c24;
}
.system-stats {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
.system-stat {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
}
.system-stat .stat-icon {
    width: 45px;
    height: 45px;
    font-size: 1.1rem;
}
.stat-info {
    flex: 1;
}
.stat-info h4 {
    margin: 0 0 0.25rem 0;
    color: var(--primary-dark);
    font-size: 1rem;
}
.stat-info p {
    margin: 0 0 0.5rem 0;
    color: #666;
    font-size: 0.9rem;
}
.stat-bar {
    width: 100%;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 0.25rem;
}
.stat-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success), #27ae60);
    border-radius: 3px;
    transition: width 0.5s ease;
}
.admin-actions {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: var(--shadow);
}
.admin-actions h3 {
    margin: 0 0 2rem 0;
    color: var(--primary-dark);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}
.action-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    padding: 1.5rem;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    text-align: center;
}
.action-card:hover {
    background: var(--primary-light);
    color: white;
    border-color: var(--primary-light);
    transform: translateY(-3px);
    box-shadow: var(--shadow);
}
.action-card i {
    font-size: 1.5rem;
}
@media (max-width: 768px) {
    .dashboard-sections {
        grid-template-columns: 1fr;
    }
    .admin-nav-enhanced {
        grid-template-columns: 1fr;
    }
    .stats-grid-enhanced {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    .actions-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
}
</style>

<script>
// Filter activity items
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Filter items
        const filter = this.dataset.filter;
        document.querySelectorAll('.activity-item').forEach(item => {
            if (filter === 'all' || item.dataset.type.includes(filter)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
});
// Quick action functions
function viewSystemLogs() {
    window.location.href = '{{ url_for("system_logs") }}';
}
function generateReport() {
    window.location.href = '{{ url_for("transaction_reports") }}';
}
function backupDatabase() {
    window.location.href = '{{ url_for("backup_database") }}';
}
function systemMaintenance() {
    window.location.href = '{{ url_for("maintenance_mode") }}';
}
function viewCurrencyRates() {
    window.location.href = '{{ url_for("currency_rates") }}';
}
function notifyUsers() {
    window.location.href = '{{ url_for("notify_users") }}';
}
function refreshSystemStats() {
    const btn = document.querySelector('.refresh-btn');
    const icon = btn.querySelector('i');
    
    icon.style.animation = 'spin 1s linear infinite';
    
    setTimeout(() => {
        icon.style.animation = '';
        // Update stats here
    }, 1000);
}
// Add spin animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
// Animate stat values on page load
document.addEventListener('DOMContentLoaded', function() {
    const statValues = document.querySelectorAll('.stat-value');
    statValues.forEach(stat => {
        const finalValue = stat.textContent.trim();
        const numValue = parseFloat(finalValue.replace(/[^0-9.-]+/g, ''));
        
        if (!isNaN(numValue)) {
            let currentValue = 0;
            const increment = numValue / 100;
            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= numValue) {
                    currentValue = numValue;
                    clearInterval(timer);
                }
                
                if (finalValue.includes('₹')) {
                    stat.textContent = '₹' + currentValue.toFixed(2);
                } else if (finalValue.includes('%')) {
                    stat.textContent = currentValue.toFixed(1) + '%';
                } else {
                    stat.textContent = Math.floor(currentValue);
                }
            }, 20);
        }
    });
});
</script>
{% endblock %}
