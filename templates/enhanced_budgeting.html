{% extends "base.html" %}

{% block title %}Enhanced Budgeting Tool - E-Bank{% endblock %}

{% block content %}
<div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div class="welcome-message" style="margin-bottom: 0;">
            <h2><i class="fas fa-chart-pie"></i> Enhanced Budgeting Tool, {{ user.name }}!</h2>
            <p>Advanced financial analytics with interactive visualizations</p>
        </div>
        
        <a href="{{ url_for('enhanced_customer_dashboard') }}" class="btn btn-blue btn-right">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Interactive Charts Section -->
    <div class="charts-container">
        <div class="chart-card">
            <h3><i class="fas fa-chart-pie"></i> Spending Breakdown (Last 30 Days)</h3>
            <div class="chart-wrapper">
                <canvas id="spendingPieChart" width="400" height="400"></canvas>
            </div>
            <div class="chart-legend" id="pieChartLegend"></div>
        </div>
        
        <div class="chart-card">
            <h3><i class="fas fa-chart-bar"></i> Financial Overview</h3>
            <div class="chart-wrapper">
                <canvas id="financialBarChart" width="400" height="400"></canvas>
            </div>
            <div class="chart-summary" id="barChartSummary"></div>
        </div>
    </div>

    <!-- Advanced Analytics -->
    <div class="analytics-section">
        <h3><i class="fas fa-brain"></i> Smart Financial Insights</h3>
        <div class="insights-grid">
            <div class="insight-card spending">
                <div class="insight-header">
                    <i class="fas fa-shopping-cart"></i>
                    <h4>Spending Pattern</h4>
                </div>
                <div class="insight-content">
                    <div class="metric">
                        <span class="metric-value" id="avgDailySpend">₹0</span>
                        <span class="metric-label">Avg Daily Spend</span>
                    </div>
                    <div class="trend" id="spendingTrend">
                        <i class="fas fa-arrow-up"></i> +5% from last month
                    </div>
                </div>
            </div>
            
            <div class="insight-card savings">
                <div class="insight-header">
                    <i class="fas fa-piggy-bank"></i>
                    <h4>Savings Rate</h4>
                </div>
                <div class="insight-content">
                    <div class="metric">
                        <span class="metric-value" id="savingsRate">0%</span>
                        <span class="metric-label">Of Total Income</span>
                    </div>
                    <div class="savings-goal">
                        <div class="goal-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="savingsProgress" style="width: 0%"></div>
                            </div>
                            <span>Goal: 20%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="insight-card transactions">
                <div class="insight-header">
                    <i class="fas fa-exchange-alt"></i>
                    <h4>Transaction Activity</h4>
                </div>
                <div class="insight-content">
                    <div class="metric">
                        <span class="metric-value" id="totalTransactions">0</span>
                        <span class="metric-label">This Month</span>
                    </div>
                    <div class="activity-breakdown">
                        <div class="activity-item">
                            <span>Deposits</span>
                            <span id="depositCount">0</span>
                        </div>
                        <div class="activity-item">
                            <span>Transfers</span>
                            <span id="transferCount">0</span>
                        </div>
                        <div class="activity-item">
                            <span>International</span>
                            <span id="internationalCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="insight-card forecast">
                <div class="insight-header">
                    <i class="fas fa-crystal-ball"></i>
                    <h4>Financial Forecast</h4>
                </div>
                <div class="insight-content">
                    <div class="forecast-item">
                        <span>Next Month Balance</span>
                        <span class="forecast-value" id="forecastBalance">₹0</span>
                    </div>
                    <div class="forecast-confidence">
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: 85%"></div>
                        </div>
                        <span>85% Confidence</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI-Powered Recommendations -->
    <div class="recommendations-section">
        <h3><i class="fas fa-robot"></i> AI-Powered Recommendations</h3>
        <div class="recommendations-grid">
            {% if suggestions %}
                {% for suggestion in suggestions %}
                <div class="recommendation-card">
                    <div class="recommendation-icon">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="recommendation-content">
                        <p>{{ suggestion }}</p>
                        <div class="recommendation-actions">
                            <button class="action-btn" onclick="implementSuggestion('{{ loop.index }}')">
                                <i class="fas fa-check"></i> Implement
                            </button>
                            <button class="action-btn secondary" onclick="dismissSuggestion('{{ loop.index }}')">
                                <i class="fas fa-times"></i> Dismiss
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="no-recommendations">
                <i class="fas fa-thumbs-up" style="color: var(--success); font-size: 3rem; margin-bottom: 1rem;"></i>
                <h4>Excellent Financial Health!</h4>
                <p>Your spending patterns look healthy. Keep up the great work!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Budget Planning Tools -->
    <div class="budget-tools">
        <h3><i class="fas fa-tools"></i> Budget Planning Tools</h3>
        <div class="tools-grid">
            <div class="tool-card" onclick="window.location.href='{{ url_for('monthly_budget_planner') }}'">
                <i class="fas fa-calendar-alt"></i>
                <h4>Monthly Budget Planner</h4>
                <p>Set spending limits and track progress</p>
            </div>
            <div class="tool-card" onclick="window.location.href='{{ url_for('savings_goal_tracker') }}'">
                <i class="fas fa-target"></i>
                <h4>Savings Goal Tracker</h4>
                <p>Set and monitor your financial goals</p>
            </div>
            <div class="tool-card" onclick="window.location.href='{{ url_for('expense_analyzer') }}'">
                <i class="fas fa-search-dollar"></i>
                <h4>Expense Analyzer</h4>
                <p>Deep dive into spending patterns</p>
            </div>
            <div class="tool-card" onclick="window.location.href='{{ url_for('investment_tracker') }}'">
                <i class="fas fa-chart-line"></i>
                <h4>Investment Tracker</h4>
                <p>Monitor investment performance</p>
            </div>
        </div>
    </div>

    <!-- Quick Stats Grid -->
    <div class="quick-stats-grid">
        <div class="stat-card income">
            <div class="stat-icon">
                <i class="fas fa-arrow-down"></i>
            </div>
            <div class="stat-info">
                <h4>Total Income</h4>
                <div class="stat-value">₹{{ "%.2f"|format(chart_data.deposits) }}</div>
                <div class="stat-change positive">+12.5% from last month</div>
            </div>
        </div>
        
        <div class="stat-card expenses">
            <div class="stat-icon">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="stat-info">
                <h4>Total Expenses</h4>
                <div class="stat-value">₹{{ "%.2f"|format(chart_data.withdrawals + chart_data.transfers + chart_data.split_payments + chart_data.international) }}</div>
                <div class="stat-change negative">+3.2% from last month</div>
            </div>
        </div>
        
        <div class="stat-card balance">
            <div class="stat-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-info">
                <h4>Current Balance</h4>
                <div class="stat-value">₹{{ "%.2f"|format(chart_data.account_balance) }}</div>
                <div class="stat-change positive">Healthy balance</div>
            </div>
        </div>
        
        <div class="stat-card efficiency">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-info">
                <h4>Savings Rate</h4>
                <div class="stat-value" id="currentSavingsRate">0%</div>
                <div class="stat-change">Target: 20%</div>
            </div>
        </div>
    </div>
</div>

<style>
.charts-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
}

.chart-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.chart-card h3 {
    color: var(--primary-dark);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chart-wrapper {
    position: relative;
    height: 300px;
    margin-bottom: 1rem;
}

.chart-legend {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 8px;
    background: #f8f9fa;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    flex-shrink: 0;
}

.legend-text {
    font-size: 0.9rem;
    color: var(--text-dark);
}

.legend-value {
    font-weight: 600;
    color: var(--primary-dark);
}

.analytics-section {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
}

.analytics-section h3 {
    color: var(--primary-dark);
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
}

.insight-card {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: 12px;
    padding: 1.5rem;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.insight-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-light);
    border-radius: 4px 4px 0 0;
}

.insight-card.spending::before {
    background: linear-gradient(90deg, #e74c3c, #c0392b);
}

.insight-card.savings::before {
    background: linear-gradient(90deg, #27ae60, #229954);
}

.insight-card.transactions::before {
    background: linear-gradient(90deg, #3498db, #2980b9);
}

.insight-card.forecast::before {
    background: linear-gradient(90deg, #9b59b6, #8e44ad);
}

.insight-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--primary-light);
}

.insight-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.insight-header i {
    font-size: 1.5rem;
    color: var(--primary-light);
}

.insight-header h4 {
    margin: 0;
    color: var(--primary-dark);
    font-size: 1.1rem;
}

.metric {
    text-align: center;
    margin-bottom: 1rem;
}

.metric-value {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-dark);
}

.metric-label {
    display: block;
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.25rem;
}

.trend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--success);
}

.savings-goal {
    margin-top: 1rem;
}

.goal-progress {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success), #27ae60);
    border-radius: 4px;
    transition: width 0.5s ease;
}

.activity-breakdown {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.activity-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #eee;
}

.activity-item:last-child {
    border-bottom: none;
}

.forecast-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.forecast-value {
    font-weight: bold;
    color: var(--primary-dark);
}

.forecast-confidence {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9rem;
}

.confidence-bar {
    flex: 1;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #f39c12, #e67e22);
    border-radius: 3px;
    transition: width 0.5s ease;
}

.recommendations-section, .budget-tools {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
}

.recommendations-section h3, .budget-tools h3 {
    color: var(--primary-dark);
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
}

.recommendation-card {
    background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
    border-radius: 12px;
    padding: 1.5rem;
    border-left: 4px solid var(--primary-light);
    display: flex;
    gap: 1rem;
    transition: all 0.3s ease;
}

.recommendation-card:hover {
    transform: translateX(5px);
    box-shadow: var(--shadow);
}

.recommendation-icon {
    flex-shrink: 0;
}

.recommendation-icon i {
    font-size: 1.5rem;
    color: var(--warning);
    background: white;
    padding: 0.75rem;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.recommendation-content {
    flex: 1;
}

.recommendation-content p {
    margin: 0 0 1rem 0;
    color: var(--text-dark);
    line-height: 1.5;
}

.recommendation-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.action-btn:not(.secondary) {
    background: var(--success);
    color: white;
}

.action-btn.secondary {
    background: #6c757d;
    color: white;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.no-recommendations {
    text-align: center;
    padding: 3rem;
    color: #666;
    grid-column: 1 / -1;
}

.tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.tool-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.tool-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
    border-color: var(--primary-light);
    background: white;
}

.tool-card i {
    font-size: 2.5rem;
    color: var(--primary-light);
    margin-bottom: 1rem;
}

.tool-card h4 {
    color: var(--primary-dark);
    margin-bottom: 0.5rem;
}

.tool-card p {
    color: #666;
    font-size: 0.9rem;
    margin: 0;
}

.quick-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    flex-shrink: 0;
}

.stat-card.income .stat-icon {
    background: linear-gradient(135deg, #27ae60, #229954);
}

.stat-card.expenses .stat-icon {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.stat-card.balance .stat-icon {
    background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
}

.stat-card.efficiency .stat-icon {
    background: linear-gradient(135deg, #f39c12, #e67e22);
}

.stat-info {
    flex: 1;
}

.stat-info h4 {
    margin: 0 0 0.5rem 0;
    color: var(--primary-dark);
    font-size: 1rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.stat-change {
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.stat-change.positive {
    color: var(--success);
}

.stat-change.negative {
    color: var(--danger);
}

@media (max-width: 1200px) {
    .charts-container {
        grid-template-columns: 1fr;
    }
    
    .insights-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    .chart-wrapper {
        height: 250px;
    }
    
    .recommendations-grid {
        grid-template-columns: 1fr;
    }
    
    .tools-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    .quick-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .stat-card {
        flex-direction: column;
        text-align: center;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
    }
}
</style>

<script>
let spendingChart, financialChart;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    updateInsights();
    animateCounters();
});

function initializeCharts() {
    const chartData = {{ chart_data|tojson }};
    
    // Create spending breakdown pie chart
    createSpendingPieChart(chartData);
    
    // Create financial overview bar chart
    createFinancialBarChart(chartData);
}

function createSpendingPieChart(data) {
    const ctx = document.getElementById('spendingPieChart').getContext('2d');
    
    const chartData = {
        labels: ['Withdrawals', 'Transfers', 'Split Payments', 'International', 'Available'],
        datasets: [{
            data: [
                data.withdrawals || 0,
                data.transfers || 0,
                data.split_payments || 0,
                data.international || 0,
                data.account_balance || 0
            ],
            backgroundColor: [
                '#e74c3c',
                '#3498db',
                '#f39c12',
                '#9b59b6',
                '#27ae60'
            ],
            borderWidth: 3,
            borderColor: '#fff',
            hoverBorderWidth: 5,
            hoverBorderColor: '#fff'
        }]
    };
    
    spendingChart = new Chart(ctx, {
        type: 'pie',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // We'll create custom legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.raw / total) * 100).toFixed(1);
                            return `${context.label}: ₹${context.raw.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1500,
                easing: 'easeOutBounce'
            },
            onHover: (event, activeElements) => {
                event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
    
    // Create custom legend
    createCustomLegend('pieChartLegend', chartData);
}

function createFinancialBarChart(data) {
    const ctx = document.getElementById('financialBarChart').getContext('2d');
    
    financialChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Income', 'Spending', 'Available', 'Savings Goal'],
            datasets: [{
                label: 'Amount (₹)',
                data: [
                    data.deposits || 0,
                    (data.withdrawals || 0) + (data.transfers || 0) + (data.split_payments || 0) + (data.international || 0),
                    data.account_balance || 0,
                    (data.deposits || 0) * 0.2 // 20% savings goal
                ],
                backgroundColor: [
                    'rgba(39, 174, 96, 0.8)',
                    'rgba(231, 76, 60, 0.8)',
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(243, 156, 18, 0.8)'
                ],
                borderColor: [
                    '#27ae60',
                    '#e74c3c',
                    '#3498db',
                    '#f39c12'
                ],
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ₹${context.raw.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString();
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });
}

function createCustomLegend(containerId, chartData) {
    const container = document.getElementById(containerId);
    const total = chartData.datasets[0].data.reduce((a, b) => a + b, 0);
    
    let legendHTML = '';
    chartData.labels.forEach((label, index) => {
        const value = chartData.datasets[0].data[index];
        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
        const color = chartData.datasets[0].backgroundColor[index];
        
        legendHTML += `
            <div class="legend-item">
                <div class="legend-color" style="background-color: ${color}"></div>
                <div class="legend-info">
                    <div class="legend-text">${label}</div>
                    <div class="legend-value">₹${value.toLocaleString()} (${percentage}%)</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = legendHTML;
}

function updateInsights() {
    const chartData = {{ chart_data|tojson }};
    
    // Update spending insights
    const totalSpending = (chartData.withdrawals || 0) + (chartData.transfers || 0) + (chartData.split_payments || 0) + (chartData.international || 0);
    const avgDailySpend = totalSpending / 30;
    document.getElementById('avgDailySpend').textContent = `₹${avgDailySpend.toFixed(0)}`;
    
    // Update savings rate
    const income = chartData.deposits || 0;
    const savingsRate = income > 0 ? ((income - totalSpending) / income * 100) : 0;
    document.getElementById('savingsRate').textContent = `${Math.max(0, savingsRate).toFixed(1)}%`;
    document.getElementById('currentSavingsRate').textContent = `${Math.max(0, savingsRate).toFixed(1)}%`;
    
    // Update savings progress
    const targetSavingsRate = 20;
    const progressPercentage = Math.min(100, (savingsRate / targetSavingsRate) * 100);
    document.getElementById('savingsProgress').style.width = `${Math.max(0, progressPercentage)}%`;
    
    // Update transaction counts with real data
    const totalTransactions = chartData.transaction_count || 0;
    document.getElementById('totalTransactions').textContent = totalTransactions;
    
    // Use real transaction counts from backend
    const depositCount = chartData.deposit_count || 0;
    const transferCount = chartData.transfer_count || 0;
    const internationalCount = chartData.international_count || 0;
    
    document.getElementById('depositCount').textContent = depositCount;
    document.getElementById('transferCount').textContent = transferCount;
    document.getElementById('internationalCount').textContent = internationalCount;
    
    // Update forecast with trend analysis
    const currentBalance = chartData.account_balance || 0;
    const monthlyTrend = avgDailySpend * 30;
    
    // Calculate trend percentage for more accurate forecast
    const trendChange = income > 0 ? ((monthlyTrend - income) / income * 100) : 0;
    const forecastMultiplier = 1 + (trendChange / 100) * 0.3; // Conservative forecast adjustment
    const forecastBalance = currentBalance + (income * 0.9) - (monthlyTrend * forecastMultiplier);
    
    document.getElementById('forecastBalance').textContent = `₹${Math.max(0, forecastBalance).toFixed(0)}`;
    
    // Update spending trend indicator
    const trendElement = document.getElementById('spendingTrend');
    if (trendChange > 5) {
        trendElement.innerHTML = '<i class="fas fa-arrow-up"></i> +' + trendChange.toFixed(1) + '% from last month';
        trendElement.style.color = '#e74c3c'; // Red for high spending
    } else if (trendChange < -5) {
        trendElement.innerHTML = '<i class="fas fa-arrow-down"></i> ' + trendChange.toFixed(1) + '% from last month';
        trendElement.style.color = '#27ae60'; // Green for savings
    } else {
        trendElement.innerHTML = '<i class="fas fa-minus"></i> Stable spending pattern';
        trendElement.style.color = '#3498db'; // Blue for stable
    }
}

function animateCounters() {
    const counters = document.querySelectorAll('.metric-value, .stat-value');
    
    counters.forEach(counter => {
        const target = parseFloat(counter.textContent.replace(/[^0-9.-]+/g, ''));
        if (isNaN(target)) return;
        
        let current = 0;
        const increment = target / 100;
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            
            // Format the number
            if (counter.textContent.includes('₹')) {
                counter.textContent = `₹${current.toFixed(0)}`;
            } else if (counter.textContent.includes('%')) {
                counter.textContent = `${current.toFixed(1)}%`;
            } else {
                counter.textContent = Math.floor(current);
            }
        }, 20);
    });
}

// Tool functions
function openBudgetPlanner() {
    showToolModal('Budget Planner', `
        <div class="tool-content">
            <h4>Set Monthly Budget Limits</h4>
            <form class="budget-form">
                <div class="form-group">
                    <label>Monthly Income Goal</label>
                    <input type="number" placeholder="Enter target income" class="form-control">
                </div>
                <div class="form-group">
                    <label>Spending Limit</label>
                    <input type="number" placeholder="Enter spending limit" class="form-control">
                </div>
                <div class="form-group">
                    <label>Savings Goal</label>
                    <input type="number" placeholder="Enter savings target" class="form-control">
                </div>
                <button type="button" class="btn" onclick="saveBudgetPlan()">Save Budget Plan</button>
            </form>
        </div>
    `);
}

function openGoalTracker() {
    showToolModal('Savings Goal Tracker', `
        <div class="tool-content">
            <h4>Track Your Financial Goals</h4>
            <div class="goals-list">
                <div class="goal-item">
                    <div class="goal-info">
                        <h5>Emergency Fund</h5>
                        <div class="goal-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 60%"></div>
                            </div>
                            <span>₹60,000 / ₹100,000</span>
                        </div>
                    </div>
                </div>
                <div class="goal-item">
                    <div class="goal-info">
                        <h5>Vacation Fund</h5>
                        <div class="goal-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 30%"></div>
                            </div>
                            <span>₹15,000 / ₹50,000</span>
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" class="btn" onclick="addNewGoal()">Add New Goal</button>
        </div>
    `);
}

function openExpenseAnalyzer() {
    showToolModal('Expense Analyzer', `
        <div class="tool-content">
            <h4>Detailed Expense Analysis</h4>
            <div class="expense-categories">
                <div class="category-item">
                    <span class="category-name">Food & Dining</span>
                    <span class="category-amount">₹8,500</span>
                    <div class="category-bar">
                        <div class="category-fill" style="width: 85%; background: #e74c3c;"></div>
                    </div>
                </div>
                <div class="category-item">
                    <span class="category-name">Transportation</span>
                    <span class="category-amount">₹3,200</span>
                    <div class="category-bar">
                        <div class="category-fill" style="width: 32%; background: #3498db;"></div>
                    </div>
                </div>
                <div class="category-item">
                    <span class="category-name">Entertainment</span>
                    <span class="category-amount">₹2,800</span>
                    <div class="category-bar">
                        <div class="category-fill" style="width: 28%; background: #f39c12;"></div>
                    </div>
                </div>
                <div class="category-item">
                    <span class="category-name">Shopping</span>
                    <span class="category-amount">₹4,500</span>
                    <div class="category-bar">
                        <div class="category-fill" style="width: 45%; background: #9b59b6;"></div>
                    </div>
                </div>
            </div>
        </div>
    `);
}

function openInvestmentTracker() {
    showToolModal('Investment Tracker', `
        <div class="tool-content">
            <h4>Investment Portfolio</h4>
            <div class="investment-summary">
                <div class="investment-metric">
                    <span class="metric-label">Total Invested</span>
                    <span class="metric-value">₹1,25,000</span>
                </div>
                <div class="investment-metric">
                    <span class="metric-label">Current Value</span>
                    <span class="metric-value">₹1,38,500</span>
                </div>
                <div class="investment-metric">
                    <span class="metric-label">Total Returns</span>
                    <span class="metric-value positive">+₹13,500 (10.8%)</span>
                </div>
            </div>
            <p style="text-align: center; color: #666; margin-top: 1rem;">
                <i class="fas fa-info-circle"></i> Investment tracking feature coming soon!
            </p>
        </div>
    `);
}

function showToolModal(title, content) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-tools"></i> ${title}</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                ${content}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    
    // Close on outside click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function implementSuggestion(index) {
    alert(`Implementing suggestion ${index}. This feature would integrate with your account settings.`);
}

function dismissSuggestion(index) {
    const cards = document.querySelectorAll('.recommendation-card');
    if (cards[index - 1]) {
        cards[index - 1].style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => {
            cards[index - 1].remove();
        }, 300);
    }
}

// Add fadeOut animation
const fadeOutStyles = document.createElement('style');
fadeOutStyles.textContent = `
    @keyframes fadeOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(-100%);
        }
    }
`;
document.head.appendChild(fadeOutStyles);
</script>
{% endblock %}